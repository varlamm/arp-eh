import{v as T}from"./vue-i18n.c6de3223.js";import{c as p,r as h,e as E,d as X}from"./@vuelidate.c7422de1.js";import{c as H,k as J,u as K,b as Q}from"./main.f5ac513d.js";import{u as W}from"./mail-driver.f62a08cc.js";import{r as B,f as Y,a as C,O as d,j as g,k as V,U as l,P as v,as as f,X as $,u as e,l as a,M as N,R as U}from"./@vue.8cc12e6e.js";const Z={class:"flex justify-between w-full"},ee={key:0,action:""},te={class:"px-8 py-8 sm:p-6"},ae={class:"z-0 flex justify-end p-4 border-t border-gray-200 border-solid"},oe={key:1},re={class:"my-6 mx-4 border border-gray-200 relative"},se=["src"],le={class:"z-0 flex justify-end p-4 border-t border-gray-200 border-solid"},pe={__name:"SendEstimateModal",emits:["update"],setup(ne,{emit:x}){const m=H(),j=J(),P=K(),k=Q();W();const{t:u}=T.useI18n(),n=B(!1),I=B(""),b=B(!1),D=B(["customer","customerCustom","estimate","estimateCustom","company"]);let o=Y({id:null,from:null,to:null,subject:"New Estimate",body:null});const G=C(()=>m.active&&m.componentName==="SendEstimateModal"),S=C(()=>m.data),R={from:{required:p.withMessage(u("validation.required"),h),email:p.withMessage(u("validation.email_incorrect"),E)},to:{required:p.withMessage(u("validation.required"),h),email:p.withMessage(u("validation.email_incorrect"),E)},subject:{required:p.withMessage(u("validation.required"),h)},body:{required:p.withMessage(u("validation.required"),h)}},r=X(R,C(()=>o));function F(){b.value=!1}async function L(){let s=await k.fetchBasicMailConfig();o.id=m.id,s.data&&(o.from=s.data.from_mail),S.value&&(o.to=S.value.customer.email),o.body=k.selectedCompanySettings.estimate_mail_body}async function q(){if(r.value.$touch(),r.value.$invalid)return!0;try{if(n.value=!0,!b.value){const c=await j.previewEstimate(o);n.value=!1,b.value=!0;var s=new Blob([c.data],{type:"text/html"});I.value=URL.createObjectURL(s);return}const t=await j.sendEstimate(o);if(n.value=!1,t.data.success)return x("update"),y(),!0}catch(t){console.error(t),n.value=!1,P.showNotification({type:"error",message:u("estimates.something_went_wrong")})}}function y(){m.closeModal(),setTimeout(()=>{r.value.$reset(),b.value=!1,I.value=null},300)}return(s,t)=>{const c=d("BaseIcon"),M=d("BaseInput"),w=d("BaseInputGroup"),O=d("BaseCustomInput"),z=d("BaseInputGrid"),_=d("BaseButton"),A=d("BaseModal");return g(),V(A,{show:G.value,onClose:y,onOpen:L},{header:l(()=>[v("div",Z,[f($(e(m).title)+" ",1),a(c,{name:"XIcon",class:"h-6 w-6 text-gray-500 cursor-pointer",onClick:y})])]),default:l(()=>[b.value?(g(),N("div",oe,[v("div",re,[a(_,{class:"absolute top-4 right-4",disabled:n.value,variant:"primary-outline",onClick:F},{default:l(()=>[a(c,{name:"PencilIcon",class:"h-5 mr-2"}),f(" Edit ")]),_:1},8,["disabled"]),v("iframe",{src:I.value,frameborder:"0",class:"w-full",style:{"min-height":"500px"}},null,8,se)]),v("div",le,[a(_,{class:"mr-3",variant:"primary-outline",type:"button",onClick:y},{default:l(()=>[f($(s.$t("general.cancel")),1)]),_:1}),a(_,{loading:n.value,disabled:n.value,variant:"primary",type:"button",onClick:q},{default:l(()=>[n.value?U("",!0):(g(),V(c,{key:0,name:"PaperAirplaneIcon",class:"mr-2"})),f(" "+$(s.$t("general.send")),1)]),_:1},8,["loading","disabled"])])])):(g(),N("form",ee,[v("div",te,[a(z,{layout:"one-column"},{default:l(()=>[a(w,{label:s.$t("general.from"),required:"",error:e(r).from.$error&&e(r).from.$errors[0].$message},{default:l(()=>[a(M,{modelValue:e(o).from,"onUpdate:modelValue":t[0]||(t[0]=i=>e(o).from=i),type:"text",invalid:e(r).from.$error,onInput:t[1]||(t[1]=i=>e(r).from.$touch())},null,8,["modelValue","invalid"])]),_:1},8,["label","error"]),a(w,{label:s.$t("general.to"),required:"",error:e(r).to.$error&&e(r).to.$errors[0].$message},{default:l(()=>[a(M,{modelValue:e(o).to,"onUpdate:modelValue":t[2]||(t[2]=i=>e(o).to=i),type:"text",invalid:e(r).to.$error,onInput:t[3]||(t[3]=i=>e(r).to.$touch())},null,8,["modelValue","invalid"])]),_:1},8,["label","error"]),a(w,{label:s.$t("general.subject"),required:"",error:e(r).subject.$error&&e(r).subject.$errors[0].$message},{default:l(()=>[a(M,{modelValue:e(o).subject,"onUpdate:modelValue":t[4]||(t[4]=i=>e(o).subject=i),type:"text",invalid:e(r).subject.$error,onInput:t[5]||(t[5]=i=>e(r).subject.$touch())},null,8,["modelValue","invalid"])]),_:1},8,["label","error"]),a(w,{label:s.$t("general.body"),required:""},{default:l(()=>[a(O,{modelValue:e(o).body,"onUpdate:modelValue":t[6]||(t[6]=i=>e(o).body=i),fields:D.value},null,8,["modelValue","fields"])]),_:1},8,["label"])]),_:1})]),v("div",ae,[a(_,{class:"mr-3",variant:"primary-outline",type:"button",onClick:y},{default:l(()=>[f($(s.$t("general.cancel")),1)]),_:1}),a(_,{loading:n.value,disabled:n.value,variant:"primary",type:"button",class:"mr-3",onClick:q},{default:l(()=>[n.value?U("",!0):(g(),V(c,{key:0,name:"PhotographIcon",class:"h-5 mr-2"})),f(" "+$(s.$t("general.preview")),1)]),_:1},8,["loading","disabled"])])]))]),_:1},8,["show"])}}};export{pe as _};
