import{h as C,u as j,j as Y,e as W,c as z,b as Z}from"./main.f5ac513d.js";import{v as q}from"./vue-i18n.c6de3223.js";import{a as D}from"./axios.7b768d2b.js";import{d as ee}from"./pinia.32c02ade.js";import{_ as te}from"./lodash.8ab3583e.js";import{u as se}from"./vue-router.746ec05f.js";import{i as ae,O as h,j as _,k as I,U as m,u as d,l as p,as as x,X as v,R as P,r as A,a as V,P as g,by as oe,M as L,F as O,aW as H,g as J,aq as ie}from"./@vue.8cc12e6e.js";import{c as U,r as X,m as ne,d as le}from"./@vuelidate.c7422de1.js";import"./v-tooltip.1cd7a91e.js";import"./vue-resize.0b8cd4b5.js";import"./@popperjs.940d197a.js";import"./vue.a6ed3e81.js";import"./@intlify.0be1c2d8.js";import"./moment.9709ab41.js";import"./guid.7b3dea7e.js";import"./@headlessui.4523e0e1.js";import"./@vueuse.b6c5a1c1.js";import"./prettier.6e0a0647.js";import"./vue-flatpickr-component.30399bbe.js";import"./flatpickr.dff0933c.js";import"./@heroicons.aa650707.js";import"./v-money3.6f830de1.js";import"./maska.1121c2e3.js";const F=(k=!1)=>{const f=k?window.pinia.defineStore:ee,{global:e}=window.i18n;return f({id:"role",state:()=>({roles:[],allAbilities:[],selectedRoles:[],currentRole:{id:null,name:"",abilities:[]}}),getters:{isEdit:s=>!!s.currentRole.id,abilitiesList:s=>{let o=s.allAbilities.map(i=>({modelName:i.model?i.model.substring(i.model.lastIndexOf("\\")+1):"Common",disabled:!1,...i}));return te.groupBy(o,"modelName")}},actions:{fetchRoles(s){return new Promise((o,i)=>{D.get("/api/v1/roles",{params:s}).then(t=>{this.roles=t.data.data,o(t)}).catch(t=>{C(t),i(t)})})},fetchRole(s){return new Promise((o,i)=>{D.get(`/api/v1/roles/${s}`).then(t=>{this.currentRole.name=t.data.data.name,this.currentRole.id=t.data.data.id,t.data.data.abilities.forEach(n=>{for(const c in this.abilitiesList)this.abilitiesList[c].forEach(y=>{y.ability===n.name&&this.currentRole.abilities.push(y)})}),o(t)}).catch(t=>{C(t),i(t)})})},addRole(s){const o=j();return new Promise((i,t)=>{D.post("/api/v1/roles",s).then(n=>{this.roles.push(n.data.role),o.showNotification({type:"success",message:e.t("settings.roles.created_message")}),i(n)}).catch(n=>{C(n),t(n)})})},updateRole(s){const o=j();return new Promise((i,t)=>{D.put(`/api/v1/roles/${s.id}`,s).then(n=>{if(n.data){let c=this.roles.findIndex(y=>y.id===n.data.data.id);this.roles[c]=s.role,o.showNotification({type:"success",message:e.t("settings.roles.updated_message")})}i(n)}).catch(n=>{C(n),t(n)})})},fetchAbilities(s){return new Promise((o,i)=>{this.allAbilities.length?o(this.allAbilities):D.get("/api/v1/abilities",{params:s}).then(t=>{this.allAbilities=t.data.abilities,o(t)}).catch(t=>{C(t),i(t)})})},deleteRole(s){const o=j();return new Promise((i,t)=>{D.delete(`/api/v1/roles/${s}`).then(n=>{let c=this.roles.findIndex(y=>y.id===s);this.roles.splice(c,1),o.showNotification({type:"success",message:e.t("settings.roles.deleted_message")}),i(n)}).catch(n=>{C(n),t(n)})})}}})()},re={__name:"RoleIndexDropdown",props:{row:{type:Object,default:null},table:{type:Object,default:null},loadData:{type:Function,default:null}},setup(k){const f=k,e=Y();j();const{t:s}=q.useI18n(),o=F(),i=se(),t=W(),n=z();ae("utils");async function c(R){Promise.all([await o.fetchAbilities(),await o.fetchRole(R)]).then(()=>{n.openModal({title:s("settings.roles.edit_role"),componentName:"RolesModal",size:"lg",refreshData:f.loadData})})}async function y(R){e.openDialog({title:s("general.are_you_sure"),message:s("settings.roles.confirm_delete"),yesLabel:s("general.ok"),noLabel:s("general.cancel"),variant:"danger",hideNoButton:!1,size:"lg"}).then(async b=>{b&&await o.deleteRole(R).then(B=>{B.data&&f.loadData&&f.loadData()})})}return(R,b)=>{const B=h("BaseIcon"),w=h("BaseButton"),a=h("BaseDropdownItem"),l=h("BaseDropdown");return _(),I(l,null,{activator:m(()=>[d(i).name==="roles.view"?(_(),I(w,{key:0,variant:"primary"},{default:m(()=>[p(B,{name:"DotsHorizontalIcon",class:"h-5 text-white"})]),_:1})):(_(),I(B,{key:1,name:"DotsHorizontalIcon",class:"h-5 text-gray-500"}))]),default:m(()=>[d(t).currentUser.is_owner?(_(),I(a,{key:0,onClick:b[0]||(b[0]=u=>c(k.row.id))},{default:m(()=>[p(B,{name:"PencilIcon",class:"w-5 h-5 mr-3 text-gray-400 group-hover:text-gray-500"}),x(" "+v(R.$t("general.edit")),1)]),_:1})):P("",!0),d(t).currentUser.is_owner?(_(),I(a,{key:1,onClick:b[1]||(b[1]=u=>y(k.row.id))},{default:m(()=>[p(B,{name:"TrashIcon",class:"w-5 h-5 mr-3 text-gray-400 group-hover:text-gray-500"}),x(" "+v(R.$t("general.delete")),1)]),_:1})):P("",!0)]),_:1})}}},de={class:"flex justify-between w-full"},ce=["onSubmit"],ue={class:"px-4 md:px-8 py-4 md:py-6"},me={class:"flex justify-between"},pe={class:"text-sm not-italic font-medium text-gray-800 px-4 md:px-8 py-1.5"},fe=g("span",{class:"text-sm text-red-500"}," *",-1),be={class:"text-sm not-italic font-medium text-gray-300 px-4 md:px-8 py-1.5"},he={class:"border-t border-gray-200 py-3"},ge={class:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 px-8 sm:px-8"},_e={class:"text-sm text-gray-500 border-b border-gray-200 pb-1 mb-2"},ye={key:0,class:"block mt-0.5 text-sm text-red-500"},ve={class:"z-0 flex justify-end p-4 border-t border-solid border--200 border-modal-bg"},we={__name:"RolesModal",setup(k){const f=z(),e=F(),{t:s}=q.useI18n();let o=A(!1),i=A(!1);const t=V(()=>f.active&&f.componentName==="RolesModal"),n=V(()=>({name:{required:U.withMessage(s("validation.required"),X),minLength:U.withMessage(s("validation.name_min_length",{count:3}),ne(3))},abilities:{required:U.withMessage(s("validation.at_least_one_ability"),X)}})),c=le(n,V(()=>e.currentRole));async function y(){if(c.value.$touch(),c.value.$invalid)return!0;try{const a=e.isEdit?e.updateRole:e.addRole;o.value=!0,await a(e.currentRole),o.value=!1,f.refreshData&&f.refreshData(),w()}catch{return o.value=!1,!0}}function R(a){if(!e.currentRole.abilities.find(u=>u.ability===a.ability)&&a?.depends_on?.length){B(a);return}a?.depends_on?.forEach(u=>{Object.keys(e.abilitiesList).forEach(r=>{e.abilitiesList[r].forEach(S=>{u===S.ability&&(S.disabled=!0,e.currentRole.abilities.find(M=>M.ability===u)||e.currentRole.abilities.push(S))})})})}function b(a){let l=[];Object.keys(e.abilitiesList).forEach(u=>{e.abilitiesList[u].forEach(r=>{r?.depends_on&&(l=[...l,...r.depends_on])})}),Object.keys(e.abilitiesList).forEach(u=>{e.abilitiesList[u].forEach(r=>{l.includes(r.ability)&&(a?r.disabled=!0:r.disabled=!1),e.currentRole.abilities.push(r)})}),a||(e.currentRole.abilities=[])}function B(a){a.depends_on.forEach(l=>{Object.keys(e.abilitiesList).forEach(u=>{e.abilitiesList[u].forEach(r=>{let S=e.currentRole.abilities.find(E=>E.depends_on?.includes(r.ability));l===r.ability&&!S&&(r.disabled=!1)})})})}function w(){f.closeModal(),setTimeout(()=>{e.currentRole={id:null,name:"",abilities:[]},Object.keys(e.abilitiesList).forEach(a=>{e.abilitiesList[a].forEach(l=>{l.disabled=!1})}),c.value.$reset()},300)}return(a,l)=>{const u=h("BaseIcon"),r=h("BaseInput"),S=h("BaseInputGroup"),E=h("BaseCheckbox"),M=h("BaseButton"),K=h("BaseModal");return _(),I(K,{show:t.value,onClose:w},{header:m(()=>[g("div",de,[x(v(d(f).title)+" ",1),p(u,{name:"XIcon",class:"w-6 h-6 text-gray-500 cursor-pointer",onClick:w})])]),default:m(()=>[g("form",{onSubmit:oe(y,["prevent"])},[g("div",ue,[p(S,{label:a.$t("settings.roles.name"),class:"mt-3",error:d(c).name.$error&&d(c).name.$errors[0].$message,required:"","content-loading":d(i)},{default:m(()=>[p(r,{modelValue:d(e).currentRole.name,"onUpdate:modelValue":l[0]||(l[0]=$=>d(e).currentRole.name=$),invalid:d(c).name.$error,type:"text","content-loading":d(i),onInput:l[1]||(l[1]=$=>d(c).name.$touch())},null,8,["modelValue","invalid","content-loading"])]),_:1},8,["label","error","content-loading"])]),g("div",me,[g("h6",pe,[x(v(a.$tc("settings.roles.permission",2))+" ",1),fe]),g("div",be,[g("a",{class:"cursor-pointer text-primary-400",onClick:l[2]||(l[2]=$=>b(!0))},v(a.$t("settings.roles.select_all")),1),x(" / "),g("a",{class:"cursor-pointer text-primary-400",onClick:l[3]||(l[3]=$=>b(!1))},v(a.$t("settings.roles.none")),1)])]),g("div",he,[g("div",ge,[(_(!0),L(O,null,H(d(e).abilitiesList,($,T)=>(_(),L("div",{key:T,class:"flex flex-col space-y-1"},[g("p",_e,v(T),1),(_(!0),L(O,null,H($,(N,Q)=>(_(),L("div",{key:Q,class:"flex"},[p(E,{modelValue:d(e).currentRole.abilities,"onUpdate:modelValue":[l[4]||(l[4]=G=>d(e).currentRole.abilities=G),G=>R(N)],"set-initial-value":!0,variant:"primary",disabled:N.disabled,label:N.name,value:N},null,8,["modelValue","disabled","label","value","onUpdate:modelValue"])]))),128))]))),128)),d(c).abilities.$error?(_(),L("span",ye,v(d(c).abilities.$errors[0].$message),1)):P("",!0)])]),g("div",ve,[p(M,{class:"mr-3 text-sm",variant:"primary-outline",type:"button",onClick:w},{default:m(()=>[x(v(a.$t("general.cancel")),1)]),_:1}),p(M,{loading:d(o),disabled:d(o),variant:"primary",type:"submit"},{left:m($=>[p(u,{name:"SaveIcon",class:J($.class)},null,8,["class"])]),default:m(()=>[x(" "+v(d(e).isEdit?a.$t("general.update"):a.$t("general.save")),1)]),_:1},8,["loading","disabled"])])],40,ce)]),_:1},8,["show"])}}},Ge={__name:"RolesSettings",setup(k){const f=z(),e=F(),s=W(),o=Z(),{t:i}=q.useI18n(),t=A(null),n=V(()=>[{key:"name",label:i("settings.roles.role_name"),thClass:"extra",tdClass:"font-medium text-gray-900"},{key:"created_at",label:i("settings.roles.added_on"),tdClass:"font-medium text-gray-900"},{key:"actions",label:"",tdClass:"text-right text-sm font-medium",sortable:!1}]);async function c({page:b,filter:B,sort:w}){let a={orderByField:w.fieldName||"created_at",orderBy:w.order||"desc",company_id:o.selectedCompany.id};return{data:(await e.fetchRoles(a)).data.data}}async function y(){t.value&&t.value.refresh()}async function R(){await e.fetchAbilities(),f.openModal({title:i("settings.roles.add_role"),componentName:"RolesModal",size:"lg",refreshData:t.value&&t.value.refresh})}return(b,B)=>{const w=h("BaseIcon"),a=h("BaseButton"),l=h("BaseTable"),u=h("BaseSettingCard");return _(),L(O,null,[p(we),p(u,{title:b.$t("settings.roles.title"),description:b.$t("settings.roles.description")},ie({default:m(()=>[p(l,{ref_key:"table",ref:t,data:c,columns:n.value,class:"mt-14"},{"cell-created_at":m(({row:r})=>[x(v(r.data.formatted_created_at),1)]),"cell-actions":m(({row:r})=>[d(s).currentUser.is_owner&&r.data.name!=="super admin"?(_(),I(re,{key:0,row:r.data,table:t.value,"load-data":y},null,8,["row","table"])):P("",!0)]),_:1},8,["columns"])]),_:2},[d(s).currentUser.is_owner?{name:"action",fn:m(()=>[p(a,{variant:"primary-outline",onClick:R},{left:m(r=>[p(w,{name:"PlusIcon",class:J(r.class)},null,8,["class"])]),default:m(()=>[x(" "+v(b.$t("settings.roles.add_new_role")),1)]),_:1})]),key:"0"}:void 0]),1032,["title","description"])],64)}}};export{Ge as default};
